<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CodeStartup Academy</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#111;
  color:white;
}

header{
  background:#1c1c1c;
  padding:15px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.container{
  width:90%;
  margin:auto;
  padding:20px;
}

.card{
  background:#1c1c1c;
  padding:20px;
  border-radius:10px;
  margin-bottom:20px;
}

input{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  border:none;
  border-radius:6px;
}

button{
  padding:10px;
  border:none;
  border-radius:6px;
  background:#00d4ff;
  color:white;
  font-weight:bold;
  cursor:pointer;
  margin:5px 0;
}

#editor{
  height:300px;
}

#output{
  background:black;
  color:#00ff00;
  padding:10px;
  border-radius:8px;
  min-height:80px;
  margin-top:10px;
  overflow:auto;
}

.hidden{display:none;}
</style>
</head>

<body>

<header>
  <h2>üöÄ CodeStartup Academy</h2>
  <div>
    <span id="userEmail"></span>
    <button onclick="logout()">Salir</button>
  </div>
</header>

<div class="container">

<div id="auth" class="card">
  <h3>Registro / Login</h3>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Contrase√±a">
  <button onclick="register()">Registrarse</button>
  <button onclick="login()">Entrar</button>
  <button onclick="googleLogin()">Entrar con Google</button>
</div>

<div id="dashboard" class="hidden">

  <div class="card">
    <h3>Nivel: <span id="nivel">1</span></h3>
    <h3>XP: <span id="xp">0</span></h3>
  </div>

  <div class="card">
    <h3>Editor</h3>
    <div id="editor"></div>
    <button onclick="runCode()">‚ñ∂ Ejecutar</button>
    <button onclick="download()">üìÇ Descargar .js</button>
    <div id="output"></div>
  </div>

  <div class="card">
    <h3>üèÜ Ranking Global</h3>
    <div id="ranking"></div>
  </div>

</div>

</div>

<script src="https://unpkg.com/monaco-editor@0.45.0/min/vs/loader.js"></script>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getAuth, 
  createUserWithEmailAndPassword, 
  signInWithEmailAndPassword,
  GoogleAuthProvider,
  signInWithPopup,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import { 
  getFirestore, 
  doc, 
  setDoc, 
  getDoc,
  updateDoc,
  collection,
  getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* üî• PEGA AQUI TUS CREDENCIALES DE FIREBASE */
const firebaseConfig = {
  apiKey: "PEGA_AQUI",
  authDomain: "PEGA_AQUI",
  projectId: "PEGA_AQUI",
  storageBucket: "PEGA_AQUI",
  messagingSenderId: "PEGA_AQUI",
  appId: "PEGA_AQUI"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

let currentUser;
let editor;

/* MONACO */
require.config({
  paths:{vs:'https://unpkg.com/monaco-editor@0.45.0/min/vs'}
});

require(['vs/editor/editor.main'],function(){
  editor=monaco.editor.create(document.getElementById('editor'),{
    value:"console.log('Hola mundo');",
    language:"javascript",
    theme:"vs-dark",
    automaticLayout:true
  });
});

/* AUTH STATE */
onAuthStateChanged(auth,user=>{
  if(user){
    currentUser=user;
    iniciar();
  }
});

/* REGISTER */
window.register=async function(){
  const email=document.getElementById("email").value;
  const pass=document.getElementById("password").value;

  const cred=await createUserWithEmailAndPassword(auth,email,pass);

  await setDoc(doc(db,"users",cred.user.uid),{
    email:email,
    xp:0,
    nivel:1
  });
}

/* LOGIN */
window.login=async function(){
  const email=document.getElementById("email").value;
  const pass=document.getElementById("password").value;
  await signInWithEmailAndPassword(auth,email,pass);
}

/* GOOGLE */
window.googleLogin=async function(){
  const result=await signInWithPopup(auth,provider);

  const ref=doc(db,"users",result.user.uid);
  const snap=await getDoc(ref);

  if(!snap.exists()){
    await setDoc(ref,{
      email:result.user.email,
      xp:0,
      nivel:1
    });
  }
}

/* DASHBOARD */
async function iniciar(){
  document.getElementById("auth").classList.add("hidden");
  document.getElementById("dashboard").classList.remove("hidden");
  document.getElementById("userEmail").textContent=currentUser.email;
  cargarDatos();
  cargarRanking();
}

async function cargarDatos(){
  const snap=await getDoc(doc(db,"users",currentUser.uid));
  const data=snap.data();
  document.getElementById("xp").textContent=data.xp;
  document.getElementById("nivel").textContent=data.nivel;
}

/* XP */
async function addXP(cant){
  const ref=doc(db,"users",currentUser.uid);
  const snap=await getDoc(ref);
  let data=snap.data();

  data.xp+=cant;

  if(data.xp>=100){
    data.nivel++;
    data.xp=0;
    alert("Subiste de nivel!");
  }

  await updateDoc(ref,data);
  cargarDatos();
  cargarRanking();
}

/* RUN */
window.runCode=function(){
  const output=document.getElementById("output");
  output.innerHTML="";
  try{
    const original=console.log;
    console.log=function(msg){
      output.innerHTML+=msg+"<br>";
    }
    eval(editor.getValue());
    console.log=original;
    addXP(20);
  }catch(e){
    output.innerHTML="Error: "+e.message;
  }
}

/* DOWNLOAD */
window.download=function(){
  const blob=new Blob([editor.getValue()],{type:"text/javascript"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="proyecto.js";
  a.click();
}

/* RANKING */
async function cargarRanking(){
  const query=await getDocs(collection(db,"users"));
  let lista=[];
  query.forEach(doc=>{
    lista.push(doc.data());
  });

  lista.sort((a,b)=>b.nivel-a.nivel);

  const div=document.getElementById("ranking");
  div.innerHTML="";

  lista.forEach(u=>{
    div.innerHTML+=`<p>${u.email} - Nivel ${u.nivel}</p>`;
  });
}

/* LOGOUT */
window.logout=async function(){
  await signOut(auth);
  location.reload();
}

</script>

</body>
</html>
